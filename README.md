# Ручки (ендпоинты)
## Регистрация и авторизация

### Логин
* **GET** `https://test-denis.wnm.digital/api/users`
В теле GET нужно передать *JSON* объект следующего вида:
```JSON
{
  "email": "example@gmail.com",
  "password": "password123"
}
```
В случае успешного логина возвращается уже готовый для последующей авторизации заголовок с токеном пользователя, в теле ответа этот токен продублирован.
Ответ выглядит следующим образом
```JSON
{
  "message": "OK",
  "user": {
    "email": "example@gmail.com",
    "first_name": "Vasya",
    "last_name": "Pupkin",
    "avatar_filename": "vasya-pupkin-1580157381837.png"
  },
  "token": "оченьдлиннаяизашифрованнаястрокаявляетсятокеномпользователя"
}
```
*avatar_filename* содержит название аватары пользователя, которая, после успешной регистрации становится доступна по адресу `https://test-denis.wnm.digital/avatars/vasya-pupkin-1580157381837.png`

**Возможные ошибки**
* Ошибки валидации тела.
В ответе придет сообщение о конкретном ключе где произошла ошибка.
* Не подходящая комбинация почта, пароль

### Регистрация
* **POST** `https://test-denis.wnm.digital/api/users`
Пароль должен содержать минимум 6 символов.
Аватар только в форматах jpg, jpeg, png. Максимум 5МБ.
Для успешной регистрации необходимо передать **multipart form-data** (все поля обязательны)
```
firstName
lastName
password
email
avatar
```
В ответе приходит уже готовый для последующей авторизации заголовок с токеном пользователя. 
Так-же возвращается тело ответа формата JSON где этот токен продублирован.
```JSON
{
  "message": "OK",
  "token": "оченьдлиннаяизашифрованнаястрокаявляетсятокеномпользователя"
}
```
**Возможные ошибки**
* Ошибки валидации тела.
В ответе придет сообщение о конкретном ключе где произошла ошибка.
* Отсутствует аватар.
* Почта уже зарегистрирована.

### Запросить аккаунт
* **GET** `https://test-denis.wnm.digital/api/users/me` 
Получить инфу об аккаунте пользователя. 
Здесь тело вообще передавать не надо, но здесь уже *нужен* токен авторизации (заголовок `Authorization: Bearer <token>`).
Возвращает JSON как при регистрации, только без токена.
```JSON
{
  "message": "OK",
  "user": {
    "email": "example@gmail.com",
    "first_name": "Vasya",
    "last_name": "Pupkin",
    "avatar_filename": "vasya-pupkin-1580157381837.png"
  }
}
```
**Возможные ошибки**
* Ошибка авторизации.

## Overwatch профили
Для всех последующих ендпоинтов нужен токен авторизации.
Заголовок (header) - `Authorization: Bearer <token>`.
~~Важно: обычно в battle.net используется `#` перед уникальным ид пользователя (прим: `FiNEk#2985`), но во всех последующих ендпоинтах вместо этого нужно передать `-` (прим: `FiNEk-2985`)~~
**Можно присылать бтег любого вида. И через `#` и через `-`**

### Поиск игрока
* **GET** `https://test-denis.wnm.digital/api/career/check` 
Проверяет, существует ли статистика для переданного в запросе никнейма.
Необходимо передать тело JSON. 
```JSON
{
  "btag": "Sammy-2461"
}
```
Возвращает JSON
```JSON
{
  "message": "OK",
  "playerExists": false
}
```
**Возможные ошибки**
* Ошибки валидации тела.
В ответе придет сообщение о конкретном ключе где произошла ошибка.
* Ошибка авторизации.

### Добавить игрока в избранное
* **GET** `https://test-denis.wnm.digital/api/career/add` 
Привязывает профиль избранного игрока к пользователю. Можно использовать много раз, пополняя таким образом список избранных игроков.
Необходимо передать тело JSON. 
```JSON
{
  "btag": "Sammy-2461"
}
```
Возвращает JSON
```JSON
{
  "message": "OK"
}
```
**Возможные ошибки**
* Ошибки валидации тела.
В ответе придет сообщение о конкретном ключе где произошла ошибка.
* Ошибка авторизации.
* Игрок не найден.
* Игрок уже в списке избранных.

### Получить избранных игроков
* **GET** `https://test-denis.wnm.digital/api/career/`
Возвращает информацию по избранным игрокам пользователя.
Никакого тела передавать сюда не надо.
Возвращает JSON
```JSON
{
  "message": "OK",
  "profiles": [
    {
      "name": "Sammy-2461",
      "ow_avatar": "https://d15f34w2p8l1cc.cloudfront.net/overwatch/f4c2e1e92d7f3ce8a08b03c4016d1a23528e9281a7de63277870af17481a4f1f.png",
      "rating_tank": null,
      "rating_dps": 4186,
      "rating_heal": null
    },
    {
      "name": "DeadlineV-2124",
      "ow_avatar": "https://d15f34w2p8l1cc.cloudfront.net/overwatch/f4c2e1e92d7f3ce8a08b03c4016d1a23528e9281a7de63277870af17481a4f1f.png",
      "rating_tank": 3303,
      "rating_dps": 2769,
      "rating_heal": 3364
    }
  ]
}
```
**Возможные ошибки**
* Ошибка авторизации.


# БД и прочее.
На сервере работает PostgreSQL 10
Имя базы с которой взаимодействует апи `wnm_owfavorites`, владелец `postgres`.
Пароль от юзера postgres - `wnmdigitaldenis`.

Установлен Node.js 13.7.0, апи крутится на процесс менеджере pm2.
Для работы апи необходимо наличие переменной среды (environment variable) `wnm_jwtPrivateKey` которой в данный момент присвоен ключ `supersecretkey`.